{% extends 'kisan_app/base.html' %}

{% block title %}Price Calculator - Kisan Project{% endblock %}

{% block content %}
<h2 style="color: #f093fb; margin-bottom: 30px; font-size: 2.5em; text-align: center;">üí∞ Crop Price Calculator</h2>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">

    <!-- Calculator Form -->
    <div class="card">
        <h3 style="color: #2c5530; margin-bottom: 20px;">üìä Calculate Your Crop Value</h3>
        <form id="priceCalculatorForm" style="space-y: 20px;">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Crop Name:</label>
                <input type="text" id="cropName" name="crop_name" required
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                    placeholder="e.g., Wheat, Rice, Cotton">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Quantity (kg):</label>
                <input type="number" id="quantity" name="quantity" required step="0.01"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                    placeholder="Enter quantity in kg">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Your Price
                    (‚Çπ/kg):</label>
                <input type="number" id="price" name="price" required step="0.01"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                    placeholder="Enter your selling price">
            </div>

            <button type="submit"
                style="width: 100%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.3s;">
                üßÆ Calculate & Compare
            </button>
        </form>
    </div>

    <!-- Results Section -->
    <div class="card">
        <h3 style="color: #2c5530; margin-bottom: 20px;">üìà Market Comparison Results</h3>
        <div id="calculationResults" style="display: none;">
            <div id="yourTotal"
                style="background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <h4>Your Total Value</h4>
                <p style="font-size: 2em; font-weight: bold; margin: 0;" id="yourTotalAmount"></p>
            </div>

            <div id="marketComparison"></div>
        </div>

        <div id="noResults" style="text-align: center; color: #666; padding: 40px;">
            <p>üîç Enter crop details to see market comparison</p>
        </div>
    </div>
</div>

<!-- Recent Market Prices -->
<div class="card">
    <h3 style="color: #2c5530; margin-bottom: 20px;">üè™ Recent Market Prices</h3>
    {% if recent_prices %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        {% for price in recent_prices %}
        <div style="border-left: 4px solid #f093fb; background: #fff5f5; padding: 15px; border-radius: 0 8px 8px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0; color: #2c5530;">{{ price.crop_name }}</h4>
                    <p style="margin: 5px 0; color: #666;">{{ price.market_location }}</p>
                    <small style="color: #999;">{{ price.date_recorded|date:"M d, Y" }} - {{ price.source }}</small>
                </div>
                <div style="text-align: right;">
                    <p style="font-size: 1.5em; font-weight: bold; color: #f093fb; margin: 0;">‚Çπ{{ price.price_per_kg }}
                    </p>
                    <small style="color: #666;">per kg</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <h3>üìä No market data available</h3>
        <p>Market prices will be displayed here once data is available.</p>
        <a href="/admin/">Add Market Prices</a>
    </div>
    {% endif %}
</div>

<!-- Price Trends and Tips -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 30px;">

    <!-- Tips Section -->
    <div class="card">
        <h3 style="color: #2c5530; margin-bottom: 20px;">üí° Pricing Tips</h3>
        <div style="space-y: 15px;">
            <div
                style="padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #2c5530; margin-bottom: 15px;">
                <h4 style="color: #2c5530; margin: 0 0 10px 0;">üéØ Market Research</h4>
                <p style="margin: 0; color: #555;">Check multiple markets and compare prices before setting your rates.
                </p>
            </div>

            <div
                style="padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #f57c00; margin-bottom: 15px;">
                <h4 style="color: #f57c00; margin: 0 0 10px 0;">üìÖ Timing Matters</h4>
                <p style="margin: 0; color: #555;">Seasonal demand affects prices. Plan your harvest timing
                    strategically.</p>
            </div>

            <div
                style="padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1976d2; margin-bottom: 15px;">
                <h4 style="color: #1976d2; margin: 0 0 10px 0;">üèÜ Quality Premium</h4>
                <p style="margin: 0; color: #555;">Higher quality crops can command premium prices in the market.</p>
            </div>

            <div
                style="padding: 15px; background: #fce4ec; border-radius: 8px; border-left: 4px solid #c2185b; margin-bottom: 15px;">
                <h4 style="color: #c2185b; margin: 0 0 10px 0;">ü§ù Direct Sales</h4>
                <p style="margin: 0; color: #555;">Consider direct-to-consumer sales to maximize profit margins.</p>
            </div>
        </div>
    </div>

    <!-- Quick Calculator -->
    <div class="card">
        <h3 style="color: #2c5530; margin-bottom: 20px;">‚ö° Quick Profit Calculator</h3>
        <div style="space-y: 15px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Investment Cost
                    (‚Çπ):</label>
                <input type="number" id="investmentCost" step="0.01"
                    style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;"
                    placeholder="Total investment in crop">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Selling Price
                    (‚Çπ):</label>
                <input type="number" id="sellingPrice" step="0.01"
                    style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;"
                    placeholder="Total selling price">
            </div>

            <div id="profitResult" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                <p style="margin: 0; color: #666;">Enter values to see profit calculation</p>
            </div>
        </div>
    </div>
</div>

<style>
    input:focus {
        border-color: #f093fb !important;
        outline: none;
        box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.1);
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('priceCalculatorForm');
        const resultsDiv = document.getElementById('calculationResults');
        const noResultsDiv = document.getElementById('noResults');
        const investmentInput = document.getElementById('investmentCost');
        const sellingPriceInput = document.getElementById('sellingPrice');
        const profitResultDiv = document.getElementById('profitResult');

        // Price calculator form submission
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(form);

            fetch('{% url "kisan_app:price_calculator" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                }
            })
                .then(response => response.json())
                .then(data => {
                    displayResults(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error calculating prices. Please try again.');
                });
        });

        // Quick profit calculator
        function updateProfitCalculation() {
            const investment = parseFloat(investmentInput.value) || 0;
            const selling = parseFloat(sellingPriceInput.value) || 0;

            if (investment > 0 && selling > 0) {
                const profit = selling - investment;
                const margin = (profit / investment) * 100;

                let resultHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Profit: ‚Çπ${profit.toFixed(2)}</strong>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Margin: ${margin.toFixed(1)}%</strong>
                </div>
            `;

                if (profit > 0) {
                    resultHTML += '<p style="color: #2c5530; margin: 0;">‚úÖ Profitable Investment!</p>';
                    profitResultDiv.style.background = '#e8f5e8';
                } else {
                    resultHTML += '<p style="color: #dc3545; margin: 0;">‚ö†Ô∏è Loss on Investment</p>';
                    profitResultDiv.style.background = '#fff5f5';
                }

                profitResultDiv.innerHTML = resultHTML;
            } else {
                profitResultDiv.innerHTML = '<p style="margin: 0; color: #666;">Enter values to see profit calculation</p>';
                profitResultDiv.style.background = '#f8f9fa';
            }
        }

        investmentInput.addEventListener('input', updateProfitCalculation);
        sellingPriceInput.addEventListener('input', updateProfitCalculation);

        function displayResults(data) {
            document.getElementById('yourTotalAmount').textContent = `‚Çπ${data.your_total.toFixed(2)}`;

            let comparisonHTML = '';
            data.calculations.forEach(calc => {
                const isProfit = calc.difference > 0;
                const bgColor = isProfit ? '#e8f5e8' : '#fff5f5';
                const textColor = isProfit ? '#2c5530' : '#dc3545';
                const icon = isProfit ? 'üìà' : 'üìâ';

                comparisonHTML += `
                <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${textColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0; color: ${textColor};">${icon} ${calc.market}</h4>
                            <p style="margin: 5px 0; color: #666;">‚Çπ${calc.price}/kg - ${calc.date}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-weight: bold; color: ${textColor};">‚Çπ${calc.total.toFixed(2)}</p>
                            <small style="color: ${textColor};">${calc.difference > 0 ? '+' : ''}‚Çπ${calc.difference.toFixed(2)} (${calc.percentage.toFixed(1)}%)</small>
                        </div>
                    </div>
                </div>
            `;
            });

            document.getElementById('marketComparison').innerHTML = comparisonHTML;

            noResultsDiv.style.display = 'none';
            resultsDiv.style.display = 'block';
        }
    });
</script>

<!-- Add CSRF token for form submission -->
{% csrf_token %}
{% endblock %}