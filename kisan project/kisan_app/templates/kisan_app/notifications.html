{% extends 'kisan_app/base.html' %}

{% block title %}Notifications - Kisan Project{% endblock %}

{% block content %}
<h2 style="color: #f093fb; margin-bottom: 30px; font-size: 2.5em; text-align: center;">üîî Notifications & Alerts</h2>

<!-- Notification Summary -->
<div class="stats-grid" style="margin-bottom: 40px;">
    <div class="stat-card" style="background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);">
        <h3>üì• Total Notifications</h3>
        <div class="number">{{ notifications|length }}</div>
        <p>All Messages</p>
    </div>

    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h3>üì¨ Unread</h3>
        <div class="number">{{ unread_notifications|length }}</div>
        <p>New Messages</p>
    </div>

    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h3>‚è∞ Harvest Alerts</h3>
        <div class="number">{{ harvest_notifications|length }}
        </div>
        <p>Harvest Reminders</p>
    </div>

    <div class="stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333;">
        <h3>üí∞ Price Alerts</h3>
        <div class="number">{{ market_notifications|length }}</div>
        <p>Market Updates</p>
    </div>
</div>

<!-- Filter Buttons -->
<div style="text-align: center; margin-bottom: 30px;">
    <button onclick="filterNotifications('all')" class="filter-btn active"
        style="background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; margin: 0 5px; cursor: pointer; font-weight: 600;">
        üìã All
    </button>
    <button onclick="filterNotifications('unread')" class="filter-btn"
        style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 20px; margin: 0 5px; cursor: pointer; font-weight: 600;">
        üì¨ Unread
    </button>
    <button onclick="filterNotifications('harvest_reminder')" class="filter-btn"
        style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 20px; margin: 0 5px; cursor: pointer; font-weight: 600;">
        ‚è∞ Harvest
    </button>
    <button onclick="filterNotifications('price_alert')" class="filter-btn"
        style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 20px; margin: 0 5px; cursor: pointer; font-weight: 600;">
        üí∞ Price
    </button>
    <button onclick="filterNotifications('weather_alert')" class="filter-btn"
        style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6; padding: 10px 20px; border-radius: 20px; margin: 0 5px; cursor: pointer; font-weight: 600;">
        üå§Ô∏è Weather
    </button>
</div>

<!-- Notifications List -->
<div id="notificationsList">
    {% if notifications %}
    {% for notification in notifications %}
    <div class="notification-card" data-type="{{ notification.notification_type }}"
        data-read="{{ notification.is_read|yesno:'true,false' }}" style="margin-bottom: 20px;">

        <div class="card"
            style="{% if not notification.is_read %}border-left: 5px solid #f093fb; background: linear-gradient(135deg, #fff5f8, #ffffff);{% endif %}">
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">

                <!-- Notification Icon -->
                <div style="flex-shrink: 0; text-align: center; padding: 10px;">
                    {% if notification.notification_type == 'harvest_reminder' %}
                    <div style="font-size: 2.5em;">‚è∞</div>
                    {% elif notification.notification_type == 'price_alert' %}
                    <div style="font-size: 2.5em;">üí∞</div>
                    {% elif notification.notification_type == 'weather_alert' %}
                    <div style="font-size: 2.5em;">üå§Ô∏è</div>
                    {% else %}
                    <div style="font-size: 2.5em;">üì¢</div>
                    {% endif %}
                </div>

                <!-- Notification Content -->
                <div style="flex: 1;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2c5530; font-size: 1.2em;">
                            {{ notification.title }}
                            {% if not notification.is_read %}
                            <span
                                style="background: #f093fb; color: white; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: 10px;">NEW</span>
                            {% endif %}
                        </h4>
                        <small style="color: #666;">{{ notification.created_at|date:"M d, Y H:i" }}</small>
                    </div>

                    <p style="margin: 0 0 15px 0; color: #555; line-height: 1.5;">
                        {{ notification.message }}
                    </p>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span
                                style="background: 
                                        {% if notification.notification_type == 'harvest_reminder' %}linear-gradient(135deg, #81c784, #4caf50)
                                        {% elif notification.notification_type == 'price_alert' %}linear-gradient(135deg, #ffb74d, #ff9800)
                                        {% elif notification.notification_type == 'weather_alert' %}linear-gradient(135deg, #64b5f6, #2196f3)
                                        {% else %}linear-gradient(135deg, #90a4ae, #607d8b){% endif %}; 
                                        color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">
                                {{ notification.get_notification_type_display }}
                            </span>
                            <span style="margin-left: 10px; color: #666; font-size: 0.9em;">
                                üë®‚Äçüåæ {{ notification.farmer.name }}
                            </span>
                        </div>

                        {% if not notification.is_read %}
                        <button onclick="markAsRead({{ notification.id }}, this)"
                            style="background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9em; font-weight: 600;">
                            ‚úì Mark as Read
                        </button>
                        {% else %}
                        <span style="color: #28a745; font-size: 0.9em; font-weight: 600;">
                            ‚úì Read
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <h3>üîî No notifications yet</h3>
        <p>Notifications and alerts will appear here to keep you updated on important farming activities.</p>
        <a href="{% url 'kisan_app:home' %}">Go to Dashboard</a>
    </div>
    {% endif %}
</div>

<!-- Quick Actions Panel -->
<div class="card" style="margin-top: 40px;">
    <h3 style="color: #2c5530; margin-bottom: 20px; text-align: center;">‚ö° Quick Actions</h3>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">

        <div
            style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e8f5e8, #c8e6c9); border-radius: 15px;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">üìä</div>
            <h4 style="color: #2c5530; margin-bottom: 10px;">View Analytics</h4>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Check your farming performance and statistics
            </p>
            <a href="{% url 'kisan_app:analytics_dashboard' %}"
                style="background: #2c5530; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 0.9em;">
                View Dashboard
            </a>
        </div>

        <div
            style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fff3e0, #ffcc02); border-radius: 15px;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">üí∞</div>
            <h4 style="color: #f57c00; margin-bottom: 10px;">Price Calculator</h4>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Calculate crop values and compare with market
                prices</p>
            <a href="{% url 'kisan_app:price_calculator' %}"
                style="background: #f57c00; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 0.9em;">
                Calculate Prices
            </a>
        </div>

        <div
            style="text-align: center; padding: 20px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 15px;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">üå§Ô∏è</div>
            <h4 style="color: #1976d2; margin-bottom: 10px;">Weather Info</h4>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Check current weather and farming tips</p>
            <a href="{% url 'kisan_app:weather_info' %}"
                style="background: #1976d2; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 0.9em;">
                View Weather
            </a>
        </div>

        <div
            style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fce4ec, #f8bbd9); border-radius: 15px;">
            <div style="font-size: 2.5em; margin-bottom: 10px;">‚öôÔ∏è</div>
            <h4 style="color: #c2185b; margin-bottom: 10px;">Admin Panel</h4>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">Manage farmers, crops, and system settings
            </p>
            <a href="/admin/"
                style="background: #c2185b; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 0.9em;">
                Go to Admin
            </a>
        </div>
    </div>
</div>

<style>
    .filter-btn.active {
        background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%) !important;
        color: white !important;
        border: none !important;
    }

    .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .notification-card {
        transition: all 0.3s ease;
    }

    .notification-card:hover {
        transform: translateX(5px);
    }
</style>

<script>
    // Filter functionality
    function filterNotifications(type) {
        const cards = document.querySelectorAll('.notification-card');
        const buttons = document.querySelectorAll('.filter-btn');

        // Update button states
        buttons.forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '#f8f9fa';
            btn.style.color = '#333';
            btn.style.border = '1px solid #dee2e6';
        });

        event.target.classList.add('active');

        // Filter notifications
        cards.forEach(card => {
            const cardType = card.dataset.type;
            const isRead = card.dataset.read === 'true';

            let show = false;

            if (type === 'all') {
                show = true;
            } else if (type === 'unread') {
                show = !isRead;
            } else {
                show = cardType === type;
            }

            if (show) {
                card.style.display = 'block';
                card.style.animation = 'fadeIn 0.5s ease';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Mark notification as read
    function markAsRead(notificationId, button) {
        fetch('{% url "kisan_app:notifications" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
            },
            body: `notification_id=${notificationId}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    button.outerHTML = '<span style="color: #28a745; font-size: 0.9em; font-weight: 600;">‚úì Read</span>';

                    // Update the card's data attribute and styling
                    const card = button.closest('.notification-card');
                    card.dataset.read = 'true';

                    // Remove the "NEW" badge
                    const newBadge = card.querySelector('span:contains("NEW")');
                    if (newBadge) {
                        newBadge.remove();
                    }

                    // Update the card styling
                    const cardInner = card.querySelector('.card');
                    cardInner.style.borderLeft = 'none';
                    cardInner.style.background = 'white';

                    // Show success message
                    showNotification('Notification marked as read!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error updating notification', 'error');
            });
    }

    // Show temporary notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        z-index: 1000;
        animation: slideIn 0.5s ease;
    `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.5s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 500);
        }, 3000);
    }

    // Animation keyframes
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); }
        to { transform: translateX(100%); }
    }
`;
    document.head.appendChild(style);

    // Auto-refresh notifications every 2 minutes
    setInterval(() => {
        console.log('Checking for new notifications...');
        // In a real application, you would fetch new notifications here
    }, 120000);
</script>

<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}